<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JustPersonal ¬∑ Rentas + Chat con Internet</title>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#3b82f6; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.45); }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,var(--bg),#020617);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:var(--text)}
    header{padding:24px 16px;border-bottom:1px solid #1f2937;background:rgba(17,24,39,.6);backdrop-filter: blur(8px);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:24px}
    main{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .full{grid-column:1/-1}
    .card{background:var(--card);border:1px solid #334155;border-radius:14px;box-shadow:var(--shadow)}
    .card header{position:initial;background:transparent;border:0;padding:16px 16px 0}
    .card .content{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #111;border-radius:12px;padding:10px 14px;color:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;background:#000;transition:.15s}
    .btn:hover{background:#0a0a0a}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:#16a34a}
    .btn.secondary{border-color:#2563eb}
    .btn.ghost{background:#000;border-color:#334155}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){main{grid-template-columns:1fr}.grid.two{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #475569;background:#0b1220;color:var(--text)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #334155;text-align:left;font-size:14px}

    /* KPI */
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .box{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:12px}
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:800;font-size:20px;margin-top:6px}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid #475569;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Chat lateral */
    .chat-launcher{position:fixed;right:18px;bottom:18px;z-index:60}
    .chat-bubble{position:fixed;right:18px;bottom:80px;width:380px;max-width:95vw;height:68vh;display:none;flex-direction:column;background:#0b1220;border:1px solid #334155;border-radius:16px;box-shadow:var(--shadow);overflow:hidden;z-index:60}
    .chat-bubble.open{display:flex}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #334155;background:#0f172a}
    .chat-title{font-weight:700}
    .chat-actions{display:flex;gap:6px}
    .chipbar{display:flex;gap:8px;flex-wrap:wrap;padding:10px;border-bottom:1px dashed #2a3550}
    .chip{padding:6px 10px;border:1px solid #3b465f;border-radius:999px;background:#111827;font-size:12px;cursor:pointer}
    .chat-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:84%;padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#111827}
    .msg.me{align-self:flex-end;background:#1e293b}
    .chat-footer{display:flex;gap:8px;padding:10px;border-top:1px solid #334155}
    .chat-footer input{flex:1}
    .typing{font-size:12px;color:#94a3b8}
    .inline-actions{display:flex;gap:8px;margin-top:6px}
  </style>
</head>
<body>
  <header class="row">
    <h1>JustPersonal ¬∑ Gesti√≥n de Alquileres</h1>
  </header>

  <main>
    <section class="card full">
      <header>
        <h2 style="margin:0">Resumen</h2>
      </header>
      <div class="content">
        <div class="row" style="align-items:end;gap:16px">
          <div>
            <label for="res-mes">Mes</label>
            <input id="res-mes" type="month" />
          </div>
          <button class="btn secondary" id="btn-refrescar-resumen" type="button">Refrescar</button>
          <div class="row" style="margin-left:auto">
            <button class="btn primary" id="btn-export" type="button">Exportar datos</button>
            <input id="file-import" type="file" accept="application/json" class="hidden" />
            <button class="btn ghost" id="btn-import" type="button">Importar datos (.json)</button>
          </div>
        </div>
        <div class="kpi" style="margin-top:12px">
          <div class="box"><div class="title">Ingresos del Mes (registrados)</div><div id="kpi-ing-manual-mes" class="value">$0</div></div>
          <div class="box"><div class="title">Ingresos por Alquiler (mes)</div><div id="kpi-ing-renta-mes" class="value">$0</div></div>
          <div class="box"><div class="title">Gastos del Mes</div><div id="kpi-gas-mes" class="value">$0</div></div>
          <div class="box"><div class="title">Saldo del Mes</div><div id="kpi-saldo-mes" class="value">$0</div></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Burbuja del Asistente -->
  <div class="chat-launcher">
    <button class="btn" id="open-chat" title="Asistente">üí¨</button>
  </div>
  <aside class="chat-bubble" id="chat-panel" aria-live="polite">
    <div class="chat-header">
      <div class="chat-title">Asistente</div>
      <div class="chat-actions">
        <button class="btn" id="btn-clear-chat" title="Borrar historial">üóëÔ∏è</button>
        <button class="btn" id="btn-close-chat" title="Cerrar">‚úñ</button>
      </div>
    </div>
    <div class="chipbar">
      <span class="chip" data-chip="finanzas">üíº Finanzas</span>
      <span class="chip" data-chip="resumen">üìä Resumen mes</span>
      <span class="chip" data-chip="ayuda">‚ùì Ayuda</span>
    </div>
    <div class="chat-body" id="chat-body"></div>
    <div class="chat-footer">
      <input id="chat-input" placeholder="Pregunta lo que quieras... (Enter para enviar)"/>
      <button class="btn primary" id="chat-send">Enviar</button>
    </div>
  </aside>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  // Utilidades
  const $ = (s, r=document)=>r.querySelector(s);
  const $$=(s, r=document)=>Array.from(r.querySelectorAll(s));
  const toast=(m)=>{const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800)};
  const storage={get:(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:(k)=>localStorage.removeItem(k)};
  const fmt=(n)=>new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(Number(n||0));

  // Estado m√≠nimo para demo de KPIs
  const state={ ingresos:[], gastos:[], chat: storage.get('ai:history',[]) };
  const persist=()=>storage.set('ai:history', state.chat);

  function renderResumen(){ /* demo */ $('#kpi-ing-manual-mes').textContent=fmt(0); $('#kpi-ing-renta-mes').textContent=fmt(0); $('#kpi-gas-mes').textContent=fmt(0); $('#kpi-saldo-mes').textContent=fmt(0); }

  // Chat
  const chat={panel:$('#chat-panel'), body:$('#chat-body'), input:$('#chat-input')};
  function pushMsg(text, me=false){const d=document.createElement('div');d.className='msg'+(me?' me':'');d.innerHTML=text;chat.body.append(d);chat.body.scrollTop=chat.body.scrollHeight;state.chat.push({me,text,ts:Date.now()});persist();}
  function openChat(){chat.panel.classList.add('open'); if(!chat.body.children.length) pushMsg('Hola, soy tu asistente. Puedo ayudarte con tus finanzas y tambi√©n buscar en **internet** para dudas generales. Escribe tu consulta.');}
  function closeChat(){chat.panel.classList.remove('open');}

  async function askInternet(q){
    try{
      const res=await fetch('/api/ask?q='+encodeURIComponent(q));
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      let html='';
      if(data.answer) html+=data.answer.replace(/\n/g,'<br>');
      if(data.sources?.length){
        html+='<div class="inline-actions">';
        data.sources.forEach(s=>{ html+=`<a class="btn ghost" href="${s.url}" target="_blank" rel="noopener">üîó ${s.title||'Fuente'}</a>`; });
        html+='</div>';
      }
      pushMsg(html);
    }catch(e){ console.error(e); pushMsg('No pude consultar internet ahora. Intenta de nuevo.'); }
  }

  async function handleSend(){ const v=(chat.input.value||'').trim(); if(!v) return; pushMsg(v,true); chat.input.value='';
    // Si detecto consulta financiera local, aqu√≠ podr√≠as enrutar; para ahora vamos a internet por defecto
    await askInternet(v);
  }

  $('#open-chat').addEventListener('click', ()=> chat.panel.classList.contains('open')?closeChat():openChat());
  $('#btn-close-chat').addEventListener('click', closeChat);
  $('#btn-clear-chat').addEventListener('click', ()=>{ state.chat=[]; persist(); chat.body.innerHTML=''; pushMsg('Historial borrado. ¬øEn qu√© seguimos?'); });
  $('#chat-send').addEventListener('click', handleSend);
  chat.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleSend(); }});

  // Restaurar historial
  (function(){ if(state.chat?.length){ state.chat.forEach(m=>{ const d=document.createElement('div'); d.className='msg'+(m.me?' me':''); d.innerHTML=m.text; chat.body.append(d); }); }})();

  renderResumen();
  </script>
</body>
</html>