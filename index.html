<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JustPersonal ¬∑ Finanzas (tema claro + IA con Internet)</title>
  <style>
    :root{
      --bg:#ffffff;         /* fondo blanco */
      --panel:#f8fafc;      /* slate-50 */
      --card:#ffffff;       /* tarjetas blancas */
      --muted:#475569;      /* slate-600 */
      --text:#0f172a;       /* slate-900 */
      --line:#e2e8f0;       /* borde claro */
      --accent:#0ea5e9;     /* sky-500 */
      --accent-2:#22c55e;   /* green-500 */
      --danger:#ef4444;     /* red-500 */
      --shadow: 0 10px 30px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:var(--text)}
    header.top{padding:20px 16px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:22px}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .full{grid-column:1/-1}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
    .card header{position:initial;background:transparent;border:0;padding:16px 16px 0}
    .card .content{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:10px 14px;color:#0f172a;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;background:#fff;transition:.15s}
    .btn:hover{background:#f1f5f9}
    .btn.primary{border-color:var(--accent);color:#0369a1}
    .btn.secondary{border-color:var(--accent-2);color:#065f46}
    .btn.danger{border-color:var(--danger);color:#991b1b}
    .btn.ghost{background:#fff;border-color:var(--line);color:#0f172a}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){main{grid-template-columns:1fr}.grid.two,.grid.three{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line)}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{background:#f8fafc}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0 0}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#0f172a;cursor:pointer;user-select:none}
    .tab[aria-selected="true"]{background:#e0f2fe;border-color:var(--accent);color:#075985}
    .hidden{display:none !important}
    .note{font-size:12px;color:var(--muted)}

    /* KPI */
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .box{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:800;font-size:20px;margin-top:6px}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid var(--line);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:.2s;z-index:60}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Chat lateral (burbuja) */
    .chat-launcher{position:fixed;right:18px;bottom:18px;z-index:70}
    .chat-bubble{position:fixed;right:18px;bottom:80px;width:380px;max-width:95vw;height:68vh;display:none;flex-direction:column;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;z-index:70}
    .chat-bubble.open{display:flex}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#f8fafc}
    .chat-title{font-weight:700}
    .chat-actions{display:flex;gap:6px}
    .chipbar{display:flex;gap:8px;flex-wrap:wrap;padding:10px;border-bottom:1px dashed var(--line)}
    .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;cursor:pointer}
    .chat-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#fff}
    .msg{max-width:84%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .msg.me{align-self:flex-end;background:#f1f5f9}
    .chat-footer{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:#fff}
    .chat-footer input{flex:1}
    .typing{font-size:12px;color:#64748b}
    .inline-actions{display:flex;gap:8px;margin-top:6px}

    /* Modal b√°sico */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.2);display:none;align-items:center;justify-content:center;padding:16px;z-index:80}
    .modal.show{display:flex}
    .modal .box{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);width:min(560px,95vw)}
    .modal .box header{padding:12px 16px;border-bottom:1px solid var(--line)}
    .modal .box .content{padding:16px}
  </style>
</head>
<body>
  <header class="top row">
    <h1>JustPersonal ¬∑ Finanzas</h1>
  </header>

  <main>
    <!-- FINANZAS -->
    <section class="card full">
      <header>
        <h2 style="margin:0">Panel de Finanzas</h2>
        <div class="tabs" role="tablist" aria-label="Gesti√≥n de Finanzas">
          <button class="tab" role="tab" aria-selected="true" aria-controls="panel-resumen" id="tab-resumen">Resumen</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-propiedades" id="tab-propiedades">Propiedades</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-ingresos" id="tab-ingresos">Ingresos</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-gastos" id="tab-gastos">Gastos</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-servicios" id="tab-servicios">Servicios</button>
        </div>
      </header>
      <div class="content">
        <!-- Resumen -->
        <div id="panel-resumen" role="tabpanel" aria-labelledby="tab-resumen">
          <div class="row" style="align-items:end;gap:16px">
            <div>
              <label for="res-mes">Mes</label>
              <input id="res-mes" type="month" />
            </div>
            <button class="btn primary" id="btn-refrescar-resumen" type="button">Refrescar</button>
            <div class="row" style="margin-left:auto">
              <button class="btn secondary" id="btn-export" type="button">Exportar</button>
              <input id="file-import" type="file" accept="application/json" class="hidden" />
              <button class="btn ghost" id="btn-import" type="button">Importar</button>
            </div>
          </div>
          <div class="kpi" style="margin-top:12px">
            <div class="box"><div class="title">Ingresos del Mes</div><div id="kpi-ing-mes" class="value">$0</div></div>
            <div class="box"><div class="title">Ingresos por Alquiler (mes)</div><div id="kpi-renta-mes" class="value">$0</div></div>
            <div class="box"><div class="title">Gastos del Mes</div><div id="kpi-gas-mes" class="value">$0</div></div>
            <div class="box"><div class="title">Saldo del Mes</div><div id="kpi-saldo-mes" class="value">$0</div></div>
          </div>
          <div class="kpi" style="margin-top:12px">
            <div class="box"><div class="title">Ingresos Acumulados</div><div id="kpi-ing-acum" class="value">$0</div></div>
            <div class="box"><div class="title">Ingresos por Alquiler (acum)</div><div id="kpi-renta-acum" class="value">$0</div></div>
            <div class="box"><div class="title">Gastos Acumulados</div><div id="kpi-gas-acum" class="value">$0</div></div>
            <div class="box"><div class="title">Saldo Acumulado</div><div id="kpi-saldo-acum" class="value">$0</div></div>
          </div>
          <p class="note" style="margin-top:8px">El acumulado de alquileres se estima desde la fecha de creaci√≥n de cada propiedad hasta el mes seleccionado.</p>
        </div>

        <!-- Propiedades -->
        <div id="panel-propiedades" class="hidden" role="tabpanel" aria-labelledby="tab-propiedades">
          <form id="form-propiedad" class="grid two" autocomplete="off">
            <input type="hidden" id="prop-id" />
            <div>
              <label for="prop-nombre">Nombre Propiedad</label>
              <input id="prop-nombre" required />
            </div>
            <div>
              <label for="prop-ciudad">Ciudad</label>
              <input id="prop-ciudad" required />
            </div>
            <div>
              <label for="prop-arrendatario">Arrendatario</label>
              <input id="prop-arrendatario" required />
            </div>
            <div>
              <label for="prop-alquiler">Alquiler Mensual ($)</label>
              <input id="prop-alquiler" type="number" step="0.01" min="0" placeholder="0" />
            </div>
            <div class="row" style="align-items:end">
              <button class="btn primary" id="btn-guardar-propiedad" type="submit">Guardar</button>
              <button class="btn ghost" id="btn-cancelar-propiedad" type="reset">Limpiar</button>
            </div>
          </form>
          <div style="margin-top:12px">
            <table id="tabla-propiedades">
              <thead><tr><th>Propiedad</th><th>Ciudad</th><th>Arrendatario</th><th>Alquiler</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Ingresos -->
        <div id="panel-ingresos" class="hidden" role="tabpanel" aria-labelledby="tab-ingresos">
          <form id="form-ingreso" class="grid three" autocomplete="off">
            <div>
              <label for="ing-monto">Monto</label>
              <input id="ing-monto" type="number" step="0.01" required />
            </div>
            <div>
              <label for="ing-desc">Descripci√≥n</label>
              <input id="ing-desc" placeholder="p.ej., Arriendo Casa A" />
            </div>
            <div>
              <label for="ing-fecha">Fecha</label>
              <input id="ing-fecha" type="date" required />
            </div>
            <div>
              <label for="ing-prop">Propiedad (opcional)</label>
              <select id="ing-prop"><option value="">‚Äî</option></select>
            </div>
            <div class="row" style="align-items:end">
              <button class="btn primary" id="btn-guardar-ingreso" type="submit">Guardar</button>
              <button class="btn ghost" type="reset">Limpiar</button>
            </div>
          </form>
          <div style="margin-top:12px">
            <table id="tabla-ingresos">
              <thead><tr><th>Fecha</th><th>Monto</th><th>Descripci√≥n</th><th>Propiedad</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Gastos -->
        <div id="panel-gastos" class="hidden" role="tabpanel" aria-labelledby="tab-gastos">
          <form id="form-gasto" class="grid three" autocomplete="off">
            <div>
              <label for="gas-monto">Monto</label>
              <input id="gas-monto" type="number" step="0.01" required />
            </div>
            <div>
              <label for="gas-fecha">Fecha</label>
              <input id="gas-fecha" type="date" required />
            </div>
            <div>
              <label for="gas-desc">Descripci√≥n</label>
              <input id="gas-desc" />
            </div>
            <div class="row" style="align-items:end">
              <button class="btn primary" id="btn-guardar-gasto" type="submit">Guardar</button>
              <button class="btn ghost" type="reset">Limpiar</button>
            </div>
          </form>
          <div style="margin-top:12px">
            <table id="tabla-gastos">
              <thead><tr><th>Fecha</th><th>Monto</th><th>Descripci√≥n</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Servicios (opcional) -->
        <div id="panel-servicios" class="hidden" role="tabpanel" aria-labelledby="tab-servicios">
          <form id="form-servicio" class="grid two" autocomplete="off">
            <div>
              <label for="serv-empresa">Empresa</label>
              <input id="serv-empresa" required />
            </div>
            <div>
              <label for="serv-propiedad">Propiedad</label>
              <input id="serv-propiedad" required />
            </div>
            <div>
              <label for="serv-ciudad">Ciudad</label>
              <input id="serv-ciudad" />
            </div>
            <div>
              <label for="serv-url">URL</label>
              <input id="serv-url" type="url" placeholder="https://" />
            </div>
            <div class="row" style="align-items:end">
              <button class="btn primary" id="btn-guardar-servicio" type="submit">Guardar</button>
              <button class="btn ghost" type="reset">Limpiar</button>
            </div>
          </form>
          <div style="margin-top:12px">
            <table id="tabla-servicios">
              <thead><tr><th>Empresa</th><th>Propiedad</th><th>Ciudad</th><th>URL</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Chat (burbuja) -->
  <div class="chat-launcher">
    <button class="btn" id="open-chat" title="Asistente">üí¨ Asistente</button>
  </div>
  <aside class="chat-bubble" id="chat-panel" aria-live="polite">
    <div class="chat-header">
      <div class="chat-title">Asistente</div>
      <div class="chat-actions">
        <button class="btn" id="btn-clear-chat" title="Borrar historial">üóëÔ∏è</button>
        <button class="btn" id="btn-close-chat" title="Cerrar">‚úñ</button>
      </div>
    </div>
    <div class="chipbar">
      <span class="chip" data-chip="finanzas">üíº Finanzas</span>
      <span class="chip" data-chip="resumen">üìä Resumen</span>
      <span class="chip" data-chip="ayuda">‚ùì Ayuda</span>
    </div>
    <div class="chat-body" id="chat-body"></div>
    <div class="chat-footer">
      <input id="chat-input" placeholder="Pregunta lo que quieras... (Enter para enviar)"/>
      <button class="btn primary" id="chat-send">Enviar</button>
    </div>
  </aside>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  // ===== Utilidades =====
  const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const toast=(m)=>{const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800)};
  const storage={ get:(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };
  const fmt=(n)=> new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(Number(n||0));
  const toYM=d=>(d||'').slice(0,7); const monthsBetween=(a,b)=>{ if(!a||!b) return 0; const [ay,am]=a.split('-').map(Number); const [by,bm]=b.split('-').map(Number); const diff=(by-ay)*12+(bm-am); return diff<0?0:diff+1; };

  // ===== Estado =====
  const DB={ props:'fin:props', ing:'fin:ing', gas:'fin:gas', serv:'fin:serv', chat:'fin:chat'};
  const state={ propiedades:storage.get(DB.props,[]), ingresos:storage.get(DB.ing,[]), gastos:storage.get(DB.gas,[]), servicios:storage.get(DB.serv,[]), chat:storage.get(DB.chat,[]) };
  const persist=()=>{ storage.set(DB.props,state.propiedades); storage.set(DB.ing,state.ingresos); storage.set(DB.gas,state.gastos); storage.set(DB.serv,state.servicios); storage.set(DB.chat,state.chat); };

  // ===== Tabs =====
  (function(){ const tabs=$$('.tab'); const panels=['resumen','propiedades','ingresos','gastos','servicios'].map(x=>'panel-'+x).map(id=>document.getElementById(id)); const sel=(id)=>{ tabs.forEach(t=>t.setAttribute('aria-selected',String(t.id==='tab-'+id))); panels.forEach(p=>p.classList.toggle('hidden',p.id!=='panel-'+id)); }; tabs.forEach(t=> t.addEventListener('click',()=> sel(t.id.replace('tab-','')))); })();

  // ===== Render combos =====
  function renderComboProps(){ const sel=$('#ing-prop'); if(!sel) return; const keep=sel.value; sel.innerHTML='<option value="">‚Äî</option>'; state.propiedades.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.nombre; sel.append(o); }); if(keep && state.propiedades.some(p=>p.id===keep)) sel.value=keep; }

  // ===== Tablas =====
  function renderPropiedades(){ const tb=$('#tabla-propiedades tbody'); tb.innerHTML=''; state.propiedades.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.nombre}</td><td>${p.ciudad}</td><td>${p.arrendatario}</td><td>${fmt(p.alquiler||0)}</td>
      <td class="row"><button class="btn ghost" data-type="prop-edit" data-i="${i}">Editar</button>
      <button class="btn ghost" data-type="prop-del" data-i="${i}">Eliminar</button></td>`; tb.append(tr); }); renderComboProps(); }
  function renderIngresos(){ const tb=$('#tabla-ingresos tbody'); tb.innerHTML=''; state.ingresos.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.fecha}</td><td>${fmt(r.monto)}</td><td>${r.desc||''}</td><td>${(state.propiedades.find(p=>p.id===r.propId)?.nombre)||''}</td>
      <td><button class="btn ghost" data-type="ing-del" data-i="${i}">Eliminar</button></td>`; tb.append(tr); }); }
  function renderGastos(){ const tb=$('#tabla-gastos tbody'); tb.innerHTML=''; state.gastos.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.fecha}</td><td>${fmt(r.monto)}</td><td>${r.desc||''}</td>
      <td><button class="btn ghost" data-type="gas-del" data-i="${i}">Eliminar</button></td>`; tb.append(tr); }); }
  function renderServicios(){ const tb=$('#tabla-servicios tbody'); tb.innerHTML=''; state.servicios.forEach((s,i)=>{ const link=s.url?`<a href="${s.url}" target="_blank" rel="noopener">abrir</a>`:''; const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.empresa}</td><td>${s.propiedad}</td><td>${s.ciudad||''}</td><td>${link}</td>
      <td><button class="btn ghost" data-type="serv-del" data-i="${i}">Eliminar</button></td>`; tb.append(tr); }); }

  // ===== Resumen =====
  const ymNow=()=>{const d=new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')};
  const sumIngMes=ym=> state.ingresos.filter(r=>toYM(r.fecha)===ym).reduce((s,r)=>s+Number(r.monto||0),0);
  const sumGasMes=ym=> state.gastos.filter(r=>toYM(r.fecha)===ym).reduce((s,r)=>s+Number(r.monto||0),0);
  const sumRentaMes=()=> state.propiedades.reduce((s,p)=>s+Number(p.alquiler||0),0);
  const sumIngAcum=()=> state.ingresos.reduce((s,r)=>s+Number(r.monto||0),0);
  const sumGasAcum=()=> state.gastos.reduce((s,r)=>s+Number(r.monto||0),0);
  const sumRentaAcumHasta=ym=> state.propiedades.reduce((s,p)=>{ const start=toYM(p.createdAt||''); const m=monthsBetween(start,ym); return s+(Number(p.alquiler||0)*m); },0);
  function renderResumen(){ const ym=$('#res-mes')?.value||ymNow(); if($('#res-mes')) $('#res-mes').value=ym; const ingM=sumIngMes(ym); const gasM=sumGasMes(ym); const rentM=sumRentaMes(); const saldoM=(ingM+rentM)-gasM; const ingA=sumIngAcum(); const gasA=sumGasAcum(); const rentA=sumRentaAcumHasta(ym); const saldoA=(ingA+rentA)-gasA; const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=fmt(v); };
    set('kpi-ing-mes',ingM); set('kpi-renta-mes',rentM); set('kpi-gas-mes',gasM); set('kpi-saldo-mes',saldoM);
    set('kpi-ing-acum',ingA); set('kpi-renta-acum',rentA); set('kpi-gas-acum',gasA); set('kpi-saldo-acum',saldoA);
  }

  // ===== Formularios =====
  let editingPropIndex=null;
  $('#form-propiedad').addEventListener('submit', (e)=>{ e.preventDefault(); const id=$('#prop-id').value||crypto.randomUUID(); const nombre=$('#prop-nombre').value.trim(); const ciudad=$('#prop-ciudad').value.trim(); const arr=$('#prop-arrendatario').value.trim(); const alquiler=Number($('#prop-alquiler').value||0); if(!nombre||!ciudad||!arr){ toast('Completa todos los campos'); return; }
    if(editingPropIndex!==null){ const prev=state.propiedades[editingPropIndex]; state.propiedades[editingPropIndex]={...prev,id,nombre,ciudad,arrendatario:arr,alquiler}; toast('Propiedad actualizada'); }
    else{ const createdAt=new Date().toISOString().slice(0,10); state.propiedades.push({id,nombre,ciudad,arrendatario:arr,alquiler,createdAt}); toast('Propiedad creada'); }
    persist(); renderPropiedades(); renderResumen(); editingPropIndex=null; $('#prop-id').value=''; e.target.reset();
  });
  $('#btn-cancelar-propiedad').addEventListener('click',()=>{ editingPropIndex=null; $('#prop-id').value=''; });

  $('#form-ingreso').addEventListener('submit',(e)=>{ e.preventDefault(); const r={ monto:$('#ing-monto').value, desc:$('#ing-desc').value.trim(), fecha:$('#ing-fecha').value, propId:($('#ing-prop').value||'')||undefined }; if(!r.monto||!r.fecha){ toast('Monto y Fecha son obligatorios'); return; } state.ingresos.push(r); persist(); renderIngresos(); renderResumen(); e.target.reset(); toast('Ingreso registrado'); });
  $('#form-gasto').addEventListener('submit',(e)=>{ e.preventDefault(); const r={ monto:$('#gas-monto').value, fecha:$('#gas-fecha').value, desc:$('#gas-desc').value.trim() }; if(!r.monto||!r.fecha){ toast('Monto y Fecha son obligatorios'); return; } state.gastos.push(r); persist(); renderGastos(); renderResumen(); e.target.reset(); toast('Gasto registrado'); });
  $('#form-servicio').addEventListener('submit',(e)=>{ e.preventDefault(); const s={ empresa:$('#serv-empresa').value.trim(), propiedad:$('#serv-propiedad').value.trim(), ciudad:$('#serv-ciudad').value.trim(), url:$('#serv-url').value.trim() }; if(!s.empresa||!s.propiedad){ toast('Empresa y Propiedad son obligatorios'); return; } state.servicios.push(s); persist(); renderServicios(); e.target.reset(); toast('Servicio guardado'); });

  // Eliminar/editar
  document.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return; const t=b.dataset.type; const i=Number(b.dataset.i);
    if(t==='prop-del'){ state.propiedades.splice(i,1); persist(); renderPropiedades(); renderResumen(); toast('Propiedad eliminada'); }
    if(t==='prop-edit'){ editingPropIndex=i; const p=state.propiedades[i]; $('#prop-id').value=p.id; $('#prop-nombre').value=p.nombre; $('#prop-ciudad').value=p.ciudad; $('#prop-arrendatario').value=p.arrendatario; $('#prop-alquiler').value=p.alquiler||0; toast('Editando propiedad‚Ä¶'); }
    if(t==='ing-del'){ state.ingresos.splice(i,1); persist(); renderIngresos(); renderResumen(); toast('Ingreso eliminado'); }
    if(t==='gas-del'){ state.gastos.splice(i,1); persist(); renderGastos(); renderResumen(); toast('Gasto eliminado'); }
    if(t==='serv-del'){ state.servicios.splice(i,1); persist(); renderServicios(); toast('Servicio eliminado'); }
  });

  // ===== Exportar/Importar =====
  function exportData(){ const payload={ app:'JustPersonal-Rentas', version:3, exportedAt:new Date().toISOString(), data:{ propiedades:state.propiedades, ingresos:state.ingresos, gastos:state.gastos, servicios:state.servicios } }; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup_rentas_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.json'; a.click(); URL.revokeObjectURL(a.href); toast('Datos exportados'); }
  async function importData(file){ try{ const text=await file.text(); const obj=JSON.parse(text); if(!obj||obj.app!=='JustPersonal-Rentas'||!obj.data){ toast('Archivo inv√°lido'); return; } state.propiedades=obj.data.propiedades||[]; state.ingresos=obj.data.ingresos||[]; state.gastos=obj.data.gastos||[]; state.servicios=obj.data.servicios||[]; persist(); renderPropiedades(); renderIngresos(); renderGastos(); renderServicios(); renderResumen(); toast('Importaci√≥n lista'); }catch(e){ console.error(e); toast('No se pudo importar'); } }
  $('#btn-export').addEventListener('click', exportData);
  $('#btn-import').addEventListener('click',()=> $('#file-import').click());
  $('#file-import').addEventListener('change',(e)=>{ const f=e.target.files?.[0]; if(f) importData(f); e.target.value=''; });

  // ===== Chat con Internet =====
  const chat={ panel:$('#chat-panel'), body:$('#chat-body'), input:$('#chat-input') };
  function pushMsg(html, me=false){ const d=document.createElement('div'); d.className='msg'+(me?' me':''); d.innerHTML=html; chat.body.append(d); chat.body.scrollTop=chat.body.scrollHeight; state.chat.push({me,html,ts:Date.now()}); storage.set(DB.chat,state.chat); }
  function openChat(){ chat.panel.classList.add('open'); if(!chat.body.children.length){ pushMsg('¬°Hola! Puedo ayudarte con tus finanzas y tambi√©n consultar **Internet**. Escribe tu pregunta o pulsa **üíº Finanzas**.'); } }
  function closeChat(){ chat.panel.classList.remove('open'); }
  $('#open-chat').addEventListener('click',()=> chat.panel.classList.contains('open')?closeChat():openChat());
  $('#btn-close-chat').addEventListener('click', closeChat);
  $('#btn-clear-chat').addEventListener('click', ()=>{ state.chat=[]; storage.set(DB.chat,[]); chat.body.innerHTML=''; pushMsg('Historial borrado. ¬øEn qu√© seguimos?'); });

  async function askInternet(q){ try{ const r=await fetch('/api/ask?q='+encodeURIComponent(q)); if(!r.ok) throw new Error('HTTP '+r.status); const data=await r.json(); let html=(data.answer||'').replace(/\n/g,'<br>'); if(Array.isArray(data.sources)&&data.sources.length){ html+='<div class="inline-actions">'; data.sources.slice(0,5).forEach(s=>{ html+=`<a class="btn" href="${s.url}" target="_blank" rel="noopener">üîó ${s.title||'Fuente'}</a>`; }); html+='</div>'; } pushMsg(html); }catch(e){ console.error(e); pushMsg('No pude consultar Internet ahora. Verifica que el proyecto est√© **conectado por Git** y exista `functions/api/ask.js`.'); } }

  async function sendChat(){ const v=(chat.input.value||'').trim(); if(!v) return; pushMsg(v,true); chat.input.value=''; await askInternet(v); }
  $('#chat-send').addEventListener('click', sendChat);
  chat.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});

  // Chips
  $$('.chip').forEach(c=> c.addEventListener('click',()=>{
    const k=c.dataset.chip;
    if(k==='finanzas'){ pushMsg('Atajos: <div class="inline-actions"><button class="btn" data-run="go-ing">+ Ingreso</button><button class="btn" data-run="go-gas">+ Gasto</button><button class="btn" data-run="go-prop">+ Propiedad</button></div>'); }
    if(k==='resumen'){ const ym=$('#res-mes')?.value||ymNow(); const ing=sumIngMes(ym), gas=sumGasMes(ym), rent=sumRentaMes(); pushMsg(`Resumen ${ym}: Ingresos ${fmt(ing)} + Alquiler ${fmt(rent)} ‚Äì Gastos ${fmt(gas)} = Saldo ${fmt(ing+rent-gas)}`); }
    if(k==='ayuda'){ pushMsg('Ejemplos: "resumen 2025-10", "total de gastos de 2025-09", o preg√∫ntame algo general (p.ej., ¬øqu√© es Cloudflare Pages Functions?).'); }
  }));

  // Acciones inline del chat
  document.addEventListener('click',(e)=>{
    const run=e.target?.dataset?.run; if(!run) return;
    if(run==='go-ing'){ document.getElementById('tab-ingresos').click(); }
    if(run==='go-gas'){ document.getElementById('tab-gastos').click(); }
    if(run==='go-prop'){ document.getElementById('tab-propiedades').click(); }
  });

  // Inicial
  renderPropiedades(); renderIngresos(); renderGastos(); renderServicios(); renderResumen();
  $('#res-mes')?.addEventListener('change', renderResumen); $('#btn-refrescar-resumen')?.addEventListener('click', renderResumen);
  </script>

<div style="margin-top:40px; padding:20px; border:1px solid #ccc; background:#f9f9f9;">
  <h3>üß† Asistente Virtual</h3>
  <input type="text" id="mensajeUsuario" placeholder="Escribe tu pregunta..." style="width:80%; padding:8px;" />
  <button onclick="enviarMensaje(document.getElementById('mensajeUsuario').value)" style="padding:8px 12px;">Enviar</button>
  <div id="respuestaAsistente" style="margin-top:10px; background:#eef; padding:10px;"></div>
</div>
<script src="ask.js"></script>

</body>
</html>